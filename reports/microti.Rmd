---
title: "Microti data analysis"
output:
  word_document: default

bibliography: biblio.bib
link-citations: yes
linkcolor: blue
---
```{r include=FALSE}
library(tidyverse)
library(sjPlot)
library(brms)
library(readxl)
library(tidybayes)
library(ggridges)
library(see)
library(bayestestR)
library(bayesplot)
library(hrbrthemes)
library(knitr)
library(here)
library(knitr)
library(kableExtra)
library(flextable)


dt <- readRDS(here("data", "processed", "dt.RDS"))

dt$id<-1:nrow(dt)

ngr<-dt %>% 
  select( "Idlinf", "totalArea",  "Grarea" , "MNC" , "Grgrade", 
          "NAF", "Micro" , "Grcompl", "id") %>% 
  group_by(Idlinf) %>%
  summarise(ngr=n())

####dataset per model con measurement error#####
dtw<-dt %>% 
  mutate(Grgrade=ifelse(Grgrade==1, "G1",
                        ifelse(Grgrade==2, "G2", 
                               ifelse(Grgrade==3, "G3", "G4")))) %>% 
  mutate(Grgrade=factor(Grgrade, levels=c("G1", "G2", "G3","G4"))) %>% 
  mutate(d=2*sqrt(Grarea/3.14)) %>% 
  group_by(Idlinf, Micro,d, Grcompl, Grgrade, MNC, NAF) %>% 
  summarise(ngr=n())%>% 
  pivot_wider( names_from = "Grgrade", values_from = ngr, values_fill = list(ngr=0)) %>% 
  group_by(Idlinf) %>% 
  summarise( mNaf=mean(log(NAF+1)), 
             mMNC=mean(log(MNC+1)),
            sG1=sum(G1), 
            sG2=sum(G2),
            sG3=sum(G3),
            sG4=sum(G4), 
            Sdg=sum(d)
            )  
lnf<- dt %>% 
  select(Idlinf, Micro,totalArea)%>% 
  mutate(D=2*sqrt(totalArea/3.14)) %>% 
  unique() 

dtM <- lnf %>% 
   left_join(dtw, by="Idlinf") %>% 
   left_join(ngr, by="Idlinf") %>% 
   mutate("Ds" = scale(D),
          Lngr = log(ngr), 
          sG1 =  sG1/ngr,
          sG2 =  sG2/ngr,
          sG3 =  sG3/ngr,
          sG4 =  sG4/ngr,
          Naf = ifelse(mNaf == 0, "No", "Si"),
          MNC = ifelse(mMNC == 0, "No", "Si"), 
          Micro = ifelse(Micro == "P", 1, 0))

```


# Material and methods
### Statistics Analysis

Two outcome variables of interest were identified

*  **Micro** microbiological status of the lymph nodes (dichotomous variable Pos / Neg)
*  **Histo** histological grade of granulomas (ordinal variable with four levels: g1 / g2 / g3 / g4)

On the basis of the nature of the outcome variable, we adapted specific regression models with the aim of identifying which variables among those measured significantly influence the outcomes.  In this sense, the variables take on the meaning of predictors, therefore able to predict the outcome value with some degree of error.


## Micro 

For this analysis, the statistical unit is the single lymph node and predictors used were:

* **Size of the lymph node**: Diameter calculated from the area and then standardized in z-score
* **NAF**: presence of acid fast bacteria in lymph node granulomas. This variable was obtained by calculating for each single lymph node the average number of bacteria present in the various granulomas and then categorizing the lymph node itself as NAF = 1 when the average was greater than 0 and NAF = 0 (i.e. absence of acid-resistant bacteria) in the case of averages equal to 0.
* **MNC**: similarly to what was done for NAF was done for the categorization of lymph nodes on the basis of the presence or absence of cells in granulomas.
* **NGR**: total number of granulomas per lymph node used in the model after logarithmic transformation.
* **sG1, sG2, sG3, sG4**: to grasp the influence that the histological grade of granulomas has on the microbiological state of a lymph node, we constructed four new variables, one for each histological grade, which identify the proportions of granulomas of the different grades for each single lymph node . For each lymph node we calculated the number of granulomas of the different histological grades and then we divided it by the total number of granulomas (**NGR**) per lymph node, thus obtaining a value between 0 and 1 which corresponds to the proportion of granulomas of the different grades. For example, 16 granulomas were observed in lymph node # 8, of which 0 of Grade 1 and 2, 13 of grade 3 and 3 of grade 4, so for lymph nodes 8 we will have this profile sG1 = 0, sG2 = 0, sG3 = 13/16 (0.81), sG4 = 3/16 (0.19).
By way of example we report in the following table lymph nodes and their profile in relation to the microbiological status to the proportion of granulomas of different histological grades and the total number of granulomas.

\



```{r echo=FALSE}
dtM %>% 
  select (Idlinf, Micro, sG1, sG2, sG3, sG4, NGR = ngr) %>% 
  slice_head(n = 5) %>% 
  round(., 2) %>% 
  flextable()
  
```

**Micro** was modeled using a Bayesian General Linear Model(McElreath) . We consider the observed positive microbiological status M as a Bernoulli realizations of a random process with probability p to be positive: 

$$M_i \sim Bernoulli(p)$$
Then p was modeled using **logit link** function : 

$$\text{logit(p)} = \alpha + \beta*X $$
Where X is the predictors design matrix; $\alpha$ is the intercept parameter and $\beta$ is the matrix of predictors regression coefficients.  
 The **logit link** maps a parameter that is defined as a probability mass, and therefore constrained to lie between zero and one, onto a linear model that can take on any real value. The logit function itself is defined as the _log-odds_ : 
 $$logit(p_i) = \text{log} \frac{p_i}{1-p_i}$$
The "odds" of an event are just the probability it happens divided by the probability it does not happen.
So we can write: 

$$\text{log} \frac{p_i}{1-p_i} = \alpha + \beta*X$$

da cui si pu√≤ derivare $p_i$ :

$$p_i=\frac{e^{(\alpha + \beta X)}}{1+e^{(\alpha + \beta X)}}$$
The above function is usually called **LOGISTIC**. In this context, it is also called the **INVERESE-LOGIT**, because it inverts the logti transform.


For both parameters ($\alpha$ and $\beta$) weakly uninformative priors were selected according to Gelman :
 $$\alpha \sim Normal(0, 1)$$    
 $$\beta \sim Normal (0, 1)$$
The model parameter estimates were obtained by sampling with the Hamiltonian Monte Carlo (HMC) algorithm using four chains, with 4000 iterations of which 1000 were warmup (excluded after sampling). For this model, the brms [@brms] package was used as the interface of the STAN [@ gelman2015stan] language implemented in R in the rstan [@rstan] package. 

Bayesian posterior estimates of the parameters  were then summarized in table using the median of the posterior distribution, the 95% credibility intervals, the **Probability Direction (PD)**, as a measure of the importance of the effects of the parameters, and the **Region of Practical Equivalence (ROPE)** as an index of significance as reported by [@ makowski2019indices].

**Probability Direction (PD)** can be interpreted as the probability that a parameter (described by its posterior distribution) is strictly positive (whichever is the most probable) and it varies between 50% and 100%. PD is defined as the proportion of the posterior distribution that is of the median's sign (Makowski....2019) 

**Region of Practical Equivalence (ROPE)** is defined as the percentage of the whole posterior distribution that lies within a Region of Practical Equivalence (ROPE) defined as range from -0.1 to 0.1 for linear regression and its equivalent, -0.18 to 0.18 for logistic models (based on the $\pi/\sqrt3$ formula to convert log odds ratios to standardized differences (Cohen....)



# Histo

For this analysis, the statistical unit is the single granuloma and predictors used were:

* **lnGrArea**: log of the granuloma area
* **lnaf**: log of the number of acid fast bacteria per granuloma
* **lmnc**: log of the number of MNCs per granuloma
* **micro**: microbiological state of the lymph nodes (Pos / Neg)
* **Grcompl**: status of complete / incomplete granuloma
* **lngr**: number of granulomas per lymph fund
* **IdLinf**: code identifier of lymph (used as a "random" variable in the model)


In this case, a Bayesian ordinal regression model was fitted according to (Burkner).  The ordinal regression models are of three different types: 

* **Cumulative Model (CM)**
* **Sequential Model (SM)**
* **Adjacent Model (AM)**

The **CM** assume that the observed ordinal variable **Y**, the histopatologic grade of granulomas in our case, originates from the categorization of a latent (not observed) continuous variable $\hat{Y}$. To model this categorization process, the **CM** assumes that there are _K_ theresholds $\tau_k$. In our study there are  $K+1 = 4$ response categoriee, and therefore $K=3$ thresholds

For many ordinal variable, the assumption of a single underlying continuos variable may not be appropriate. If the response can be understood as being the result of a sequential process, such that a higher response category is possible only after all lower categories are achieved, the **SM** model as proposed by Tutz (1990) is usually appropriate. In our study this type of model assumes that the different classes of the outcome variable (in this case the histological grade) are the expression of a sequential process for which, for example, a granuloma is classified as grade 4, after having "evolved" from the previous grades.

The **AC** is a widely used ordinal model in item-response theory and is applied in many large scale assessment studies. AC is very different to the CM and SM because it is difficult to think of a natural process leading to it. AC can be chosen for its mathematical convenience rather than any quality of interpretation. 
We chose SM  because the assumption of the model with respect to the variable outcome is consistent with the histological development of the granulomas. 

The model is further complicated by the hierarchical structure of the data, whereby observations made at the granuloma level are nested under the lymph nodes.





